name: main
on:
  push:
    tags:
      - '[0-9]+\.[0-9]+\.[0-9]'

jobs:

  docker:
    runs-on: ubuntu-latest
    timeout-minutes: 14400
    steps:
      - name: checkout
        uses: actions/checkout@v1
      - name: login to dockerhub registry
        run: echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USER }} --password-stdin
      - name: build or pull docker image using git tag
        run: |
          if ! docker pull flaport/condalayout:${{ github.ref_name}} > /dev/null 2> /dev/null; then
            export WORKERS=2;
            export PYTHON_SEMVER=3.8;
            export KLAYOUT_SEMVER=${{ github.ref_name }};
            export BUILD_NUMBER=0;
            export PYTHON_PYVER="$(echo "$PYTHON_SEMVER" | sed "s/\(^[0-9]\+\)\.\([0-9]\+\).*/\1\2/g")";
            export BUILD_SUFFIX="$KLAYOUT_SEMVER-$PYTHON_PYVER_$BUILD_NUMBER";
            export KLAYOUT_PYPI_LINK="$(cat klayout-pypi-links.txt | grep manylinux | grep $KLAYOUT_SEMVER | grep $PYTHON_PYVER | head -1)" && [ ! -z "$KLAYOUT_PYPI_LINK" ];
            docker build . -t flaport/condalayout:$KLAYOUT_SEMVER \
              --build-arg WORKERS=$WORKERS \
              --build-arg PYTHON_SEMVER=$PYTHON_SEMVER \
              --build-arg KLAYOUT_SEMVER=$KLAYOUT_SEMVER \
              --build-arg BUILD_NUMBER=$BUILD_NUMBER \
              --build-arg PYTHON_PYVER=$PYTHON_PYVER \
              --build-arg BUILD_SUFFIX=$BUILD_SUFFIX \
              --build-arg KLAYOUT_PYPI_LINK=$KLAYOUT_PYPI_LINK;
          fi
      - name: tag docker image as latest
        run: docker tag flaport/condalayout:${{ github.ref_name }} flaport/condalayout:latest
      - name: push docker image
        run: docker push flaport/condalayout:latest && docker push flaport/condalayout:${{ github.ref_name }}

  release:
    runs-on: ubuntu-latest
    needs:
      - docker
    container:
      image: flaport/condalayout
    steps:
      - name: create release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          draft: false
          prerelease: false
          release_name: KLayout v${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
      - name: klayout-gui - add gzip tarball to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /klayout/dist/klayout-gui-0.27.8-py38_0.tar.gz
          asset_name: klayout-gui-0.27.8-py38_0.tar.gz
          asset_content_type: application/x-gzip
      - name: klayout-gui - add bzip tarball to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /klayout/dist/klayout-gui-0.27.8-py38_0.tar.bz2
          asset_name: klayout-gui-0.27.8-py38_0.tar.bz2
          asset_content_type: application/x-bzip2
      - name: klayout - add bzip tarball to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /klayout/dist/klayout-0.27.8-py38_0.tar.bz2
          asset_name: klayout-0.27.8-py38_0.tar.bz2
          asset_content_type: application/x-bzip2
      - name: login to anaconda.org
        run: anaconda login --username '${{ secrets.ANACONDA_USER }}' --password '${{ secrets.ANACONDA_PASSWORD }}'
      - name: klayout-gui - upload to anaconda.org
        run: anaconda upload /klayout/dist/klayout-gui-0.27.8-py38_0.tar.bz2
      - name: klayout - upload to anaconda.org
        run: anaconda upload /klayout/dist/klayout-0.27.8-py38_0.tar.bz2
